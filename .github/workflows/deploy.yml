name: Deploy to Server (DevSecOps)

on:
  push:
    branches:
      - main
      - master

jobs:
  # =========================
  # SECURITY GATE
  # =========================
  security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ” SAST
      - name: SAST - Semgrep
        uses: returntocorp/semgrep-action@v1
        with:
          config: auto

      # ğŸ” Dependency Scan
      - name: Dependency Scan - Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          exit-code: 1

  # =========================
  # DEPLOYMENT
  # =========================
  deploy:
    needs: security   # â¬…ï¸ SECURITY GATE
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            export DEBIAN_FRONTEND=noninteractive

            mkdir -p /var/www/server-monitoring
            cd /var/www/server-monitoring

            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            fi

            chmod -R 755 /var/www/server-monitoring

            echo "ğŸ“¦ Installing dependencies..."
            npm install --production

            echo "ğŸ”„ Restarting Node.js server..."
            pm2 delete absensi 2>/dev/null || true
            pm2 start ecosystem.config.js 2>/dev/null || pm2 start server.js --name "absensi"
            pm2 save

            echo "ğŸ”„ Reloading NGINX..."
            nginx -t && systemctl reload nginx

            echo "âœ… Deployment completed!"

      - name: Notify Success
        if: success()
        run: echo "ğŸ‰ Deployment successful!"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ Deployment failed!"
