name: Deploy to Server

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          script: |
            # Navigate to project directory
            cd /root/server-monitoring || mkdir -p /root/server-monitoring

            # Clone if not exists, else pull
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            fi

            echo "ğŸ” Setting permissions for NGINX..."
            chmod 755 /root
            chmod -R 755 /root/server-monitoring

            echo "ğŸ“¦ Installing dependencies..."
            npm install --production

            echo "ğŸ”„ Restarting Node.js server..."
            pm2 restart absensi || pm2 start server.js --name "absensi"
            pm2 save

            echo "ğŸ”„ Updating NGINX configuration..."
            cp nginx/absensi.conf /etc/nginx/sites-available/mitrjaya.my.id
            ln -sf /etc/nginx/sites-available/mitrjaya.my.id /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            echo "âœ… Deployment completed!"

      - name: Notify Success
        if: success()
        run: echo "ğŸ‰ Deployment successful to mitrjaya.my.id!"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ Deployment failed!"
