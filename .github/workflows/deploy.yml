name: Deploy to Server

on:
  push:
    branches:
      - main
      - master

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            export DEBIAN_FRONTEND=noninteractive

            # Create directory if not exists
            mkdir -p /var/www/server-monitoring

            # Navigate to project directory
            cd /var/www/server-monitoring

            # Clone if not exists, else pull
            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            fi

            # Set permissions
            chmod -R 755 /var/www/server-monitoring

            echo "ğŸ˜ Checking PostgreSQL..."
            # Install PostgreSQL if not installed
            if ! command -v psql &> /dev/null; then
              echo "Installing PostgreSQL..."
              apt-get update -qq
              apt-get install -y -qq postgresql postgresql-contrib
            fi

            # Start PostgreSQL if not running
            systemctl start postgresql 2>/dev/null || true
            systemctl enable postgresql 2>/dev/null || true

            # Wait for PostgreSQL to be ready
            sleep 3

            # Setup database user and database
            echo "Setting up database..."
            sudo -u postgres psql -tc "SELECT 1 FROM pg_user WHERE usename = 'absensi_user'" | grep -q 1 || \
              sudo -u postgres psql -c "CREATE USER absensi_user WITH PASSWORD 'absensi_password';"

            sudo -u postgres psql -tc "SELECT 1 FROM pg_database WHERE datname = 'db_absensi'" | grep -q 1 || \
              sudo -u postgres psql -c "CREATE DATABASE db_absensi OWNER absensi_user;"

            sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE db_absensi TO absensi_user;" 2>/dev/null || true
            sudo -u postgres psql -d db_absensi -c "GRANT ALL ON SCHEMA public TO absensi_user;" 2>/dev/null || true

            # Import schema if tables don't exist
            if ! sudo -u postgres psql -d db_absensi -tc "SELECT 1 FROM pegawai LIMIT 1" 2>/dev/null | grep -q 1; then
              echo "Importing database schema..."
              sudo -u postgres psql -d db_absensi -f /var/www/server-monitoring/sql/database_postgresql.sql 2>/dev/null || true
            fi

            echo "ğŸ“¦ Installing dependencies..."
            npm install --production

            echo "ğŸ”„ Restarting Node.js server..."
            pm2 restart absensi 2>/dev/null || pm2 start server.js --name "absensi"
            pm2 save

            echo "ğŸ”„ Updating NGINX configuration..."
            cp nginx/absensi.conf /etc/nginx/sites-available/mitrjaya.my.id
            ln -sf /etc/nginx/sites-available/mitrjaya.my.id /etc/nginx/sites-enabled/
            nginx -t && systemctl reload nginx

            echo "âœ… Deployment completed!"

      - name: Notify Success
        if: success()
        run: echo "ğŸ‰ Deployment successful to mitrjaya.my.id!"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ Deployment failed!"
