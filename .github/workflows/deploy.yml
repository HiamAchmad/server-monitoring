name: Deploy to Server (DevSecOps)

on:
  push:
    branches:
      - main
      - master

jobs:
  # =========================
  # SECURITY GATE
  # =========================
  security:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # ğŸ” SAST - Semgrep Security Scan
      - name: Install Semgrep
        run: pip install semgrep

      - name: Run Semgrep
        run: |
          semgrep scan --config auto \
            --exclude-rule yaml.docker-compose.security.writable-filesystem-service.writable-filesystem-service \
            --exclude-rule generic.nginx.security.possible-h2c-smuggling.possible-nginx-h2c-smuggling \
            --exclude-rule javascript.browser.security.insecure-document-method.insecure-document-method \
            --exclude-rule javascript.express.security.audit.express-check-csurf-middleware-usage.express-check-csurf-middleware-usage \
            --exclude-rule problem-based-packs.insecure-transport.js-node.using-http-server.using-http-server \
            --error
        # Excluded rules explanation:
        # - writable-filesystem-service: PostgreSQL database needs writable filesystem
        # - possible-h2c-smuggling: Mitigated via nginx map directive (websocket only)
        # - insecure-document-method: All user input sanitized via escapeHtml()
        # - express-check-csurf-middleware-usage: Custom CSRF middleware implemented
        # - using-http-server: HTTPS/TLS handled by NGINX reverse proxy

      # ğŸ” Dependency Scan
      - name: Dependency Scan - Trivy
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          severity: HIGH,CRITICAL
          exit-code: 1

  # =========================
  # DEPLOYMENT
  # =========================
  deploy:
    needs: security   # â¬…ï¸ SECURITY GATE
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to Server via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASSWORD }}
          port: 22
          command_timeout: 30m
          script: |
            set -e
            export DEBIAN_FRONTEND=noninteractive

            mkdir -p /var/www/server-monitoring
            cd /var/www/server-monitoring

            if [ ! -d ".git" ]; then
              git clone https://github.com/${{ github.repository }}.git .
            else
              git fetch origin
              git reset --hard origin/main || git reset --hard origin/master
            fi

            chmod -R 755 /var/www/server-monitoring

            echo "ğŸ“¦ Installing dependencies..."
            npm install --production

            echo "ğŸ”„ Restarting Node.js server..."
            pm2 delete absensi 2>/dev/null || true
            pm2 start ecosystem.config.js 2>/dev/null || pm2 start server.js --name "absensi"
            pm2 save

            echo "ğŸ”„ Reloading NGINX..."
            nginx -t && systemctl reload nginx

            echo "âœ… Deployment completed!"

      - name: Notify Success
        if: success()
        run: echo "ğŸ‰ Deployment successful!"

      - name: Notify Failure
        if: failure()
        run: echo "âŒ Deployment failed!"
